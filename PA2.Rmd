---
title: "Analysis of the economic and population health impact of severe weather events in the USA" 
output: 
  html_document:
    keep_md: true
---
## Synopsis
Data from the NOAA Storm database was analysed to determine the types of weather event most commonly associated with fatalities and injuries, and compared to those recorded as causing the most property and crop damage.

## Data Processing


### Loading libraries
Loading R libraries used as part of this analysis. 
```{r }
require(data.table)
require(lubridate)
require(dplyr)
require(ggplot2)
```

### Loading the data
Data was sourced from a copy of the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database that had been stored on the Reproducible Research web site. The following code will download it and store it locally unless a previously downloaded copy is found, in which case this is used instead.

The data is described in great detail in the National Weather Service Storm Data Documentation (10-1605 7thAug2007). A copy is available from https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf.
```{r }

fname<-"repdata-data-StormData.csv.bz2"
if (!file.exists(fname)){
        message(paste("Cannot find",fname,"in local directory, downloading it..."))
        setInternet2(TRUE)  # set R_WIN_INTERNET2 to TRUE so https is supported in knitr (see http://stackoverflow.com/questions/19890633/r-produces-unsupported-url-scheme-error-when-getting-data-from-https-sites)
        download.file("https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2",fname)

  
} else {
        message(paste("Found ",fname,"in local directory, reusing it..."))
}
```

The file was first downloaded on Tue Aug 18 2015 and has an MD5 hash of df4aa61fff89427db6b7f7b1113b5553 (generated by Microsoft's File Checksum Integrity Verifier version 2.05).

Reading in the source file takes a while, so the read is cached.
```{r cache=TRUE}

# load("data.no.remarks.RData")
ptm <- proc.time()
  df<-read.csv("repdata_data_StormData.csv.bz2",stringsAsFactors=TRUE)
proc.time() - ptm

```
### Tidying the data
A lot of the columns in the data are not required for this investigation. 

The year of the record is derived from the BGN_DATE field. 

The STATE field is retained to allow more detailed analysis at a later stage, however this is not within the scope of the current analysis.

EVTYPE is an important attribute contianing a classification of the weather event.

FATALITIES and INJURIES are integers indicating the number of deaths and injuries linked to the event.

PROPDMG is a number which, in combination with a multiplier held in PROPDMGEXP, indicates the estimated amount of property damage in USD.

CROPDMG is a number which, in combination with a multiplier held in CROPDMGEXP, indicates the estimated amount of crop damage in USD.

REFNUM is not used further in this analysis, but was retained in order to uniquely identify the orginal record and facilitate tracking down the REMARKS in the original file when checking for the validity of outliers.
```{r}
clean_data<-df %>% mutate(year=year(mdy_hms(BGN_DATE))) %>%
        select(year,STATE,EVTYPE,FATALITIES, INJURIES, PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP, CROPDMGEXP, REFNUM)
str(clean_data)
```
There are 955 levels in the EVTYPE factor.
The National Weather Service recognises 48 different Event Names

```{r}
# Official NOAA list of valid Events from 
# table 2.1.1 on page 6 of the National Weather Service Storm Data Documentation 10-1605 7 Aug2007

valid_events <- c("Astronomical Low Tide", "Avalanche", 
"Blizzard", "Coastal Flood", "Cold/Wind Chill", "Debris Flow", 
"Dense Fog", "Dense Smoke", "Drought", "Dust Devil", "Dust Storm", 
"Excessive Heat", "Extreme Cold/Wind Chill", "Flash Flood", "Flood", 
"Frost/Freeze", "Funnel Cloud", "Freezing Fog", "Hail", "Heat", 
"Heavy Rain", "Heavy Snow", "High Surf", "High Wind", "Hurricane (Typhoon)", 
"Ice Storm", "Lake-Effect Snow", "Lakeshore Flood", "Lightning", 
"Marine Hail", "Marine High Wind", "Marine Strong Wind", "Marine Thunderstorm Wind", 
"Rip Current", "Seiche", "Sleet", "Storm Surge/Tide", "Strong Wind", 
"Thunderstorm Wind", "Tornado", "Tropical Depression", "Tropical Storm", 
"Tsunami", "Volcanic Ash", "Waterspout", "Wildfire", "Winter Storm", 
"Winter Weather")
valid_events_u <- toupper(valid_events)
```
So we add a new field, event, which should only hold a valid value or NA
```{r}
clean_data<-clean_data %>% mutate(event=ifelse(toupper(EVTYPE) %in% valid_events_u,toupper(EVTYPE),NA)) 
```
However, of a total `r nrow(clean_data)` rows of data, `r nrow(filter(clean_data,is.na(event)))` do not fit. The top missing categories are:

```{r}
count(subset(clean_data,is.na(event)),EVTYPE,sort=TRUE)
 
```
Correcting some of the low hanging fruit as follows:
```{r}
target<-clean_data$EVTYPE %in% c("TSTM WIND", 
                                 "THUNDERSTORM WINDS",
                                 "TSTM WIND/HAIL")
clean_data[target,]<- mutate(clean_data[target,],event="THUNDERSTORM WIND") 

target<-clean_data$EVTYPE %in% c("MARINE TSTM WIND")
clean_data[target,]<- mutate(clean_data[target,],event="MARINE THUNDERSTORM WIND") 

target<-clean_data$EVTYPE %in% c("HIGH WINDS")
clean_data[target,]<- mutate(clean_data[target,],event="HIGH WIND") 

count(subset(clean_data,is.na(event)),EVTYPE,sort=TRUE)

```
While it would be possible to continue in this vain, the percentage of accurately classified events is now `r 100 - 100 * (nrow(filter(clean_data,is.na(event)))/ nrow(clean_data))` which should be good enough for our purposes. 

### Preparing to look at population health impact

We will exclude rows with no event, no fatalities and no injuries.
```{r}
health_data<-clean_data %>% filter((INJURIES>0 | FATALITIES >0) & !is.na(event))

h<- summarise(group_by(health_data,event),Deaths=sum(FATALITIES),Injuries=sum(INJURIES))
h<-arrange(h,desc(Deaths))
qplot(Deaths,event, data=h)
qplot(Injuries,event, data=h)

```

## Results
